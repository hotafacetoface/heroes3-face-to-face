<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ì–†–û–ö–ê ‚Äî –õ–∏—Ü–æ–º –∫ –ª–∏—Ü—É</title>

  <!-- –°—Ç–∏–ª–∏ –∏ —à—Ä–∏—Ñ—Ç -->
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
<!-- ‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∑–∞–º–∫–æ–≤ -->
  <script src="js/icons-castles.js"></script>
 <!-- ‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–∫–æ–Ω–æ–∫ –≥–µ—Ä–æ–µ–≤ -->
<script src="js/icons-heroes.js"></script>
<!-- ‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–∫–æ–Ω–æ–∫ –º–æ–Ω—Å—Ç—Ä–æ–≤ -->
<script src="js/icons-monsters.js"></script>
<!-- ‚úÖ –ì—Ä–∞—Ñ–∏–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ–º main.js -->
<script src="js/main.js" defer></script>
</head>
\1

<!-- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á—É–∂–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<script>
(function(){
  const params = new URLSearchParams(location.search);
  const userParam = params.get('user');
  if (!userParam) return;

  // –ü—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞, –Ω–µ —Ç—Ä–æ–≥–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  window.viewedUser = userParam.trim();

  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ title
  document.title = "–õ–∏—Ü–æ–º –∫ –ª–∏—Ü—É ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ " + userParam;
  const header = document.querySelector("#stats-title, #page-title, #playerTitle");
  if (header) header.textContent = "–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ì–†–û–ö–ê: " + userParam;
})();
</script>


  <!-- –ú–µ–Ω—é -->
  <div id="menu-placeholder"></div>
  <script>
    fetch("menu.html")
      .then(r => r.text())
      .then(d => {
        document.getElementById("menu-placeholder").innerHTML = d;
        // ‚úÖ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –º–µ–Ω—é –≤—ã–∑—ã–≤–∞–µ–º initMenu (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –æ–±—â–µ–º JS)
        if (typeof initMenu === "function") initMenu();
      })
      .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", err));
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
  <div class="container">
    <h1 class="page-title">–ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h1>

    <div class="stats-wrapper">
      <!-- ‚úÖ –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –Ω–∏–∫, –∏–∫–æ–Ω–∫–∞, –≠–ª–æ –∏ –†–∞–Ω–≥ -->
      <div id="player-info" class="player-info">
        <div id="player-name" class="player-name"></div>

        <div class="hero-frame" id="hero-frame">
          <img id="hero-image" alt="–ì–µ—Ä–æ–π" />
        </div>

        <div class="player-elo" id="player-elo"></div>
        <div class="player-rank" id="player-rank"></div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div id="stats-container" class="stats-section"></div>
    </div>
  </div>

  <!-- –õ–æ–∞–¥–µ—Ä -->
  <div id="loader" class="loader-overlay" style="display: none;">
    <div class="loader"></div>
  </div>
<!-- –õ–æ–∞–¥–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ó–∞–º–∫–∏") -->
<div id="tab-loader" class="loader-overlay" style="display: none;">
  <div class="loader"></div>
</div>
  <script>
// ‚úÖ –ù–∞–¥—ë–∂–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∏–∫–∞, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –ø—Ä–∏ JSONP-–≤—ã–∑–æ–≤–∞—Ö
const params = new URLSearchParams(location.search);
const username = params.get("user") || window.viewedUser || localStorage.getItem("authUser");
window.viewedUser = username; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ
if (!username) window.location.href = "login.html";

    async function fetchUserStats(username) {
      const url = "https://script.google.com/macros/s/AKfycbyFBd0h8ErXgmA16lByhsvOgVAJ-7zFkspg1t8TuK1hS0AVr4ACizgINDNR7thG4gcgag/exec?username=" + encodeURIComponent(username);
      const res = await fetch(url);
      return res.json();
    }

    /* ‚úÖ –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Ä–µ–∑–æ–ª–≤–µ—Ä –∏–∫–æ–Ω–∫–∏ –≥–µ—Ä–æ—è:
       - —á–∏—Å—Ç–∏–º –∏–º—è (trim, —É–±–∏—Ä–∞–µ–º –∑–≤–µ–∑–¥–æ—á–∫–∏)
       - –∏—â–µ–º —Ç–æ—á–Ω–æ–µ –∏ –±–µ–∑—Ä–µ–≥–∏—Å—Ç—Ä–æ–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
       - –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π placeholder (SVG), —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–±–∏—Ç–æ–π¬ª –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
  function resolveHeroIcon(heroName) {
    if (!heroName) return null;

    // –∏—Å–∫–ª—é—á–∞–µ–º "–ù–ó", "-", "‚Äî"
    if (/^(–Ω–∑|nz|‚Äî|-)$/i.test(heroName)) return null;

    const clean = String(heroName).replace(/\*/g, "").trim();

    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å–ª–æ–≤–∞—Ä—é
    const dict = window.heroIcons || {};

    // —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if (dict[clean]) return dict[clean];

    // –±–µ–∑—Ä–µ–≥–∏—Å—Ç—Ä–æ–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    const key = Object.keys(dict).find(k => k.toLowerCase() === clean.toLowerCase());
    return key ? dict[key] : null;
  }


    // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π placeholder (SVG), –µ—Å–ª–∏ –∏–∫–æ–Ω–∫—É –Ω–µ –Ω–∞—à–ª–∏
    const HERO_PLACEHOLDER =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160">
        <rect width="100%" height="100%" fill="#0d1b2a"/>
        <rect x="6" y="6" width="148" height="148" fill="none" stroke="#6e4f1a" stroke-width="6"/>
        <circle cx="80" cy="60" r="28" fill="#1b263b"/>
        <rect x="40" y="96" width="80" height="40" rx="10" fill="#1b263b"/>
        <text x="50%" y="152" fill="#ffd700" font-size="16" font-family="monospace" text-anchor="middle">H3</text>
      </svg>`);
const ranks = [
  { name: "–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω",   icon: "–∫—Ä–µ—Å—Ç—å—è–Ω–µ", min: 0, max: 499 },
  { name: "–í–æ—Ä",          icon: "–≤–æ—Ä—ã", min: 500, max: 749 },
  { name: "–ù–∞–µ–∑–¥–Ω–∏–∫ –Ω–∞ –∫–∞–±–∞–Ω–µ", icon: "–Ω–∞–µ–∑–¥–Ω–∏–∫–∏ –Ω–∞ –∫–∞–±–∞–Ω–∞—Ö", min: 750, max: 999 },
  { name: "–õ–µ–ø—Ä–µ–∫–æ–Ω",     icon: "–ª–µ–ø—Ä–µ–∫–æ–Ω—ã", min: 1000, max: 1099 },
  { name: "–ú—É–º–∏—è",        icon: "–º—É–º–∏–∏", min: 1100, max: 1199 },
  { name: "–ö–æ—á–µ–≤–Ω–∏–∫",     icon: "–∫–æ—á–µ–≤–Ω–∏–∫", min: 1200, max: 1299 },
  { name: "–°–∞—Ç–∏—Ä",        icon: "—Å–∞—Ç–∏—Ä—ã", min: 1300, max: 1399 },
  { name: "–°–Ω–∞–π–ø–µ—Ä",      icon: "—Å–Ω–∞–π–ø–µ—Ä—ã", min: 1400, max: 1499 },
  { name: "–°—Ç–∞–ª—å–Ω–æ–π –≥–æ–ª–µ–º", icon: "—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ–ª–µ–º—ã", min: 1500, max: 1599 },
  { name: "–ó–æ–ª–æ—Ç–æ–π –≥–æ–ª–µ–º",  icon: "–∑–æ–ª–æ—Ç—ã–µ –≥–æ–ª–µ–º—ã", min: 1600, max: 1699 },
  { name: "–§–∞–Ω–≥–∞—Ä–º",        icon: "—Ñ–∞–Ω–≥–∞—Ä–º—ã", min: 1700, max: 1799 },
  { name: "–¢—Ä–æ–ª–ª—å",         icon: "—Ç—Ä–æ–ª–ª–∏", min: 1800, max: 1899 },
  { name: "–ê–ª–º–∞–∑–Ω—ã–π –≥–æ–ª–µ–º", icon: "–∞–ª–º–∞–∑–Ω—ã–µ –≥–æ–ª–µ–º—ã", min: 1900, max: 1999 },
  { name: "–ö–æ–ª–¥—É–Ω",         icon: "–∫–æ–ª–¥—É–Ω—ã", min: 2000, max: 2049 },
  { name: "–°–∫–∞–∑–æ—á–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", icon: "—Å–∫–∞–∑–æ—á–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", min: 2050, max: 2099 },
  { name: "–†–∂–∞–≤—ã–π –¥—Ä–∞–∫–æ–Ω",   icon: "—Ä–∂–∞–≤—ã–π –¥—Ä–∞–∫–æ–Ω", min: 2100, max: 2149 },
  { name: "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", icon: "–∫—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", min: 2150, max: 2199 },
  { name: "–õ–∞–∑—É—Ä–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", icon: "–ª–∞–∑—É—Ä–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", min: 2200, max: 9999 }
];
function getPlayerRank(elo, totalGames) {
  if (totalGames < 10) {
    return { name: "–ù–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ", icon: null };
  }
  for (const rank of ranks) {
    if (elo >= rank.min && elo <= rank.max) {
      const iconUrl = window.monsterIcons?.[rank.icon]?.icon || null;
      return { name: rank.name, icon: iconUrl };
    }
  }
  return { name: "–ë–µ–∑ —Ä–∞–Ω–≥–∞", icon: null };
}

    async function initMyStats() {
      const loader = document.getElementById("loader");
      const container = document.getElementById("stats-container");

      const playerName = document.getElementById("player-name");
      const heroImg    = document.getElementById("hero-image");
      const heroFrame  = document.getElementById("hero-frame");
      const playerElo  = document.getElementById("player-elo");
      const playerRank = document.getElementById("player-rank");

      loader.style.display = "flex";

      try {
        const stats = await fetchUserStats(username);
                // –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å
        playerName.textContent = stats.username || username;
        playerElo.innerHTML = `–≠–ª–æ: <span style="color:#ffd700">${stats.elo ?? "‚Äî"}</span>`;
        const playerRankData = getPlayerRank(stats.elo, stats.totalGames);
if (playerRankData.icon) {
  playerRank.innerHTML = `
    –†–∞–Ω–≥: <span style="color:#ffd700">${playerRankData.name}</span>
    <div><img src="${playerRankData.icon}" alt="${playerRankData.name}" class="rank-icon"></div>
  `;
} else {
  playerRank.innerHTML = `–†–∞–Ω–≥: <span style="color:#ffd700">${playerRankData.name}</span>`;
}
        // –ò–∫–æ–Ω–∫–∞ –≥–µ—Ä–æ—è
        const iconUrl = resolveHeroIcon(stats.mostPlayedHero);
        heroImg.src = iconUrl || HERO_PLACEHOLDER;
        heroImg.onerror = () => (heroImg.src = HERO_PLACEHOLDER); // –∑–∞—â–∏—Ç–∞ –æ—Ç –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫
// === –ë–ª–∏–∂–∞–π—à–∏–µ —Ä–∞–Ω–≥–∏ ===
const currentRankIndex = ranks.findIndex(r => stats.elo >= r.min && stats.elo <= r.max);
const startIndex = Math.max(0, currentRankIndex - 2);
const endIndex = Math.min(ranks.length - 1, currentRankIndex + 2);

const nearbyRanks = ranks.slice(startIndex, endIndex + 1);
const nearbyHTML = nearbyRanks.map((r, i) => {
  const iconUrl = window.monsterIcons?.[r.icon]?.icon || HERO_PLACEHOLDER;
  const isCurrent = i + startIndex === currentRankIndex;
  return `
    <div class="rank-row ${isCurrent ? 'current' : ''}">
      <div class="rank-row-icon"><img src="${iconUrl}" alt="${r.name}" /></div>
      <div class="rank-row-name">${r.name}</div>
      <div class="rank-row-range">${r.min} ‚Äî ${r.max}</div>
    </div>
  `;
}).join("");

playerRank.insertAdjacentHTML("afterend", `
  <div class="rank-table">
    <div class="rank-table-title">–ë–õ–ò–ñ–ê–ô–®–ò–ï –†–ê–ù–ì–ò</div>
    <div class="rank-table-body">${nearbyHTML}</div>
  </div>
`);
        // –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å
container.innerHTML = `
  <div class="tabs">
    <button class="tab-button active" data-tab="tab-general">–û–±—â–∞—è</button>
    <button class="tab-button" data-tab="tab-castles">–ó–∞–º–∫–∏</button>
    <button class="tab-button" data-tab="tab-heroes">–ì–µ—Ä–æ–∏</button>
    <button class="tab-button" data-tab="tab-other">–ü—Ä–æ—á–µ–µ</button>
  </div>

  <!-- === –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ === -->
  <div id="tab-general" class="tab-content active">
    <div class="section">
      <div class="section-title">–û–ë–©–ò–ï –î–ê–ù–ù–´–ï</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">–ú–∞—Ç—á–µ–π</div><div class="stat-value">${stats.totalGames ?? 0}</div></div>
        <div class="stat-card"><div class="stat-label">–ü–æ–±–µ–¥—ã</div><div class="stat-value">${stats.wins ?? 0}</div></div>
        <div class="stat-card"><div class="stat-label">–ü–æ—Ä–∞–∂–µ–Ω–∏—è</div><div class="stat-value">${stats.losses ?? 0}</div></div>
        <div class="stat-card"><div class="stat-label">–í–∏–Ω—Ä–µ–π—Ç</div><div class="stat-value">${(stats.winrate ?? 0)}%</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">–ì–†–ê–§–ò–ö –ò–ó–ú–ï–ù–ï–ù–ò–Ø –≠–õ–û –ó–ê –ü–û–°–õ–ï–î–ù–ò–ï 30 –î–ù–ï–ô</div>
      <div class="chart-wrapper">
        <canvas id="eloChart"></canvas>
      </div>
    </div>
  </div>

<div id="tab-castles" class="tab-content">
<div id="castle-content" style="display:none;">
  
  <!-- –∫–Ω–æ–ø–∫–∞ –Ω–∞–¥ —Å–µ—Ç–∫–æ–π -->
  <div class="castle-full-link top-link">
    <button id="open-full-castle-stats">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
  </div>

  <!-- —Å–µ—Ç–∫–∞ 2x2 —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ -->
  <div class="castle-grid-4">

      <!-- 1Ô∏è‚É£ –õ—é–±–∏–º—ã–π –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞ -->
      <div class="castle-card">
        <div class="castle-card-title">–õ—é–±–∏–º—ã–π –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="favCastle-icon" alt="–ó–∞–º–æ–∫" />
            <div id="favCastle-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="favCastle-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="favCastle-winrate">‚Äî%</span></div>
          <div class="castle-stat">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä—Ç–∞: <span id="favCastle-gold">‚Äî</span></div>
          <div class="castle-icon-block">
            <img id="favCastle-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="favCastle-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- 2Ô∏è‚É£ –õ—É—á—à–∏–π –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞ -->
      <div class="castle-card">
        <div class="castle-card-title">–õ—É—á—à–∏–π –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="bestCastle-icon" alt="–ó–∞–º–æ–∫" />
            <div id="bestCastle-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="bestCastle-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="bestCastle-winrate">‚Äî%</span></div>
          <div class="castle-stat">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä—Ç–∞: <span id="bestCastle-gold">‚Äî</span></div>
          <div class="castle-icon-block">
            <img id="bestCastle-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="bestCastle-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>
      <!-- 3Ô∏è‚É£ –•—É–¥—à–∏–π –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞ -->
      <div class="castle-card">
        <div class="castle-card-title">–•—É–¥—à–∏–π –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="worstCastle-icon" alt="–ó–∞–º–æ–∫" />
            <div id="worstCastle-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="worstCastle-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="worstCastle-winrate">‚Äî%</span></div>
          <div class="castle-stat">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä—Ç–∞: <span id="worstCastle-gold">‚Äî</span></div>
          <div class="castle-icon-block">
            <img id="worstCastle-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="worstCastle-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- 4Ô∏è‚É£ –¢—è–∂–µ–ª–æ –∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤ -->
      <div class="castle-card">
        <div class="castle-card-title">–¢—è–∂–µ–ª–æ –∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="hardCastle-icon" alt="–ó–∞–º–æ–∫" />
            <div id="hardCastle-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="hardCastle-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="hardCastle-winrate">‚Äî%</span></div>
          <div class="castle-stat">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä—Ç–∞: <span id="hardCastle-gold">‚Äî</span></div>
          <div class="castle-icon-block">
            <img id="hardCastle-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="hardCastle-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>
<!-- === –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É === -->


    </div>
  </div>
</div>

<div id="tab-heroes" class="tab-content">
  <div id="hero-content" style="display:none;">
    <div class="castle-full-link top-link">
      <button id="open-full-hero-stats">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–µ—Ä–æ–µ–≤</button>
    </div>

    <div class="castle-grid-4">

      <!-- 1Ô∏è‚É£ –õ—é–±–∏–º—ã–π –≥–µ—Ä–æ–π -->
      <div class="castle-card">
        <div class="castle-card-title">–õ—é–±–∏–º—ã–π –≥–µ—Ä–æ–π</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="favHero-icon" alt="–ì–µ—Ä–æ–π" />
            <div id="favHero-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="favHero-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="favHero-winrate">‚Äî%</span></div>
          <div class="castle-stat">–õ—é–±–∏–º–æ–µ —Å—É—â–µ—Å—Ç–≤–æ:</div>
          <div class="castle-icon-block">
            <img id="favHero-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="favHero-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- 2Ô∏è‚É£ –õ—É—á—à–∏–π –≥–µ—Ä–æ–π -->
      <div class="castle-card">
        <div class="castle-card-title">–õ—É—á—à–∏–π –≥–µ—Ä–æ–π</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="bestHero-icon" alt="–ì–µ—Ä–æ–π" />
            <div id="bestHero-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="bestHero-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="bestHero-winrate">‚Äî%</span></div>
          <div class="castle-stat">–õ—é–±–∏–º–æ–µ —Å—É—â–µ—Å—Ç–≤–æ:</div>
          <div class="castle-icon-block">
            <img id="bestHero-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="bestHero-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- 3Ô∏è‚É£ –•—É–¥—à–∏–π –≥–µ—Ä–æ–π -->
      <div class="castle-card">
        <div class="castle-card-title">–•—É–¥—à–∏–π –≥–µ—Ä–æ–π</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="worstHero-icon" alt="–ì–µ—Ä–æ–π" />
            <div id="worstHero-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="worstHero-matches">‚Äî</span></div>
          <div class="castle-stat">–í–∏–Ω—Ä–µ–π—Ç: <span id="worstHero-winrate">‚Äî%</span></div>
          <div class="castle-stat">–õ—é–±–∏–º–æ–µ —Å—É—â–µ—Å—Ç–≤–æ:</div>
          <div class="castle-icon-block">
            <img id="worstHero-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="worstHero-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- 4Ô∏è‚É£ –ù–µ–Ω–∞–≤–∏—Å—Ç–Ω—ã–π –≤—Ä–∞–≥ -->
      <div class="castle-card">
        <div class="castle-card-title">–ù–µ–Ω–∞–≤–∏—Å—Ç–Ω—ã–π –≤—Ä–∞–≥</div>
        <div class="castle-card-body">
          <div class="castle-icon-block">
            <img id="enemyHero-icon" alt="–ì–µ—Ä–æ–π" />
            <div id="enemyHero-name" class="castle-name">‚Äî</div>
          </div>
          <div class="castle-stat">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: <span id="enemyHero-matches">‚Äî</span></div>
          <div class="castle-stat">–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ –ø—Ä–æ—Ç–∏–≤: <span id="enemyHero-winrate">‚Äî%</span></div>
          <div class="castle-stat">–ù–µ–Ω–∞–≤–∏—Å—Ç–Ω–æ–µ —Å—É—â–µ—Å—Ç–≤–æ:</div>
          <div class="castle-icon-block">
            <img id="enemyHero-unit-icon" alt="–Æ–Ω–∏—Ç" />
            <div id="enemyHero-unit" class="castle-name">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <div id="tab-other" class="tab-content">
    <div class="section"><div class="section-title">–ü—Ä–æ—á–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><p style="text-align:center;opacity:.8;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏.</p></div>
  </div>`;

await loadEloChart(stats.username);
// === –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∑–∞–º–∫–æ–≤ ===
const fullCastleBtn = document.getElementById("open-full-castle-stats");
if (fullCastleBtn) {
  fullCastleBtn.addEventListener("click", () => {
    localStorage.setItem("selectedUsername", username);
    window.location.href = "castle_stat_player.html";
  });
}
// === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ + –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∑–∞–º–∫–∞–º ===
document.querySelectorAll(".tab-button").forEach(btn => {
  btn.addEventListener("click", async () => {
    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");

    // ‚úÖ –ü–æ–¥–≥—Ä—É–∂–∞–µ–º castleStats —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
    if (btn.dataset.tab === "tab-castles" && !castleStatsLoaded) {
      await loadCastleStats(username);
    }
    if (btn.dataset.tab === "tab-heroes" && !heroStatsLoaded) {
  await loadHeroStats(username);
}

  });
});


      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", err);
        container.innerHTML = `<p>‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>`;
      } finally {
        loader.style.display = "none";
      }
    }
// === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∑–∞–º–∫–∞–º ===
let castleStatsLoaded = false;

// === –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∑–∞–º–∫–∞–º (—á–µ—Ä–µ–∑ getGeneralStats) ===
async function loadCastleStats(username) {
  const tabLoader = document.getElementById("tab-loader");
  const content = document.getElementById("castle-content");

  tabLoader.style.display = "flex";
  content.style.display = "none";

  const scriptUrl = "https://script.google.com/macros/s/AKfycbwus43_mJRl-50ygI8lbGiJDtmwDPS0HtkaxDCfIMqnSs9TzvYB4Ic1nhejEaDncYASRw/exec";

  try {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—Ç—á–∏ –∏–≥—Ä–æ–∫–∞
    const jsonpData = await jsonpRequest(`${scriptUrl}?action=getGeneralStats&player=${encodeURIComponent(username)}`, 10000);
    const matches = jsonpData?.values || [];
    if (!matches.length) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

    // === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä ===
    const castles = [
      "–ó–∞–º–æ–∫","–û–ø–ª–æ—Ç","–ë–∞—à–Ω—è","–ò–Ω—Ñ–µ—Ä–Ω–æ","–ù–µ–∫—Ä–æ–ø–æ–ª–∏—Å",
      "–¢–µ–º–Ω–∏—Ü–∞","–¶–∏—Ç–∞–¥–µ–ª—å","–ö—Ä–µ–ø–æ—Å—Ç—å","–°–æ–ø—Ä—è–∂–µ–Ω–∏–µ","–ü—Ä–∏—á–∞–ª","–§–∞–±—Ä–∏–∫–∞"
    ];
    const stats = {};
    castles.forEach(c => stats[c] = {
      games:0,wins:0,losses:0,golds:[],
      units:{}, winsByUnit:{}, lossesByUnit:{}
    });

    // === –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –º–∞—Ç—á–∞–º ===
    matches.forEach(row => {
      const player = row.nickPlayer;
      const enemy = row.nickEnemy;
      const isPlayer = player === username;
      const isEnemy = enemy === username;
      if (!isPlayer && !isEnemy) return;

      const castle = isPlayer ? row.castlePlayer : row.castleEnemy;
      const castleEnemy = isPlayer ? row.castleEnemy : row.castlePlayer;
      const result = row.result;
      const unit = isPlayer ? row.stackPlayer : row.stackEnemy;
      const gold = Number(row.goldDiff || 0);

      if (!stats[castle]) return;
      const cs = stats[castle];

      cs.games++;
      const win = (isPlayer && result === "–ü–æ–±–µ–¥–∞") || (isEnemy && result === "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ");
      if (win) cs.wins++; else cs.losses++;
      cs.golds.push(isEnemy ? -gold : gold);

      // —Å—á–∏—Ç–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø–æ —é–Ω–∏—Ç–∞–º
      if (unit && unit !== "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö") {
        cs.units[unit] = (cs.units[unit] || 0) + 1;
        if (win) cs.winsByUnit[unit] = (cs.winsByUnit[unit] || 0) + 1;
        else cs.lossesByUnit[unit] = (cs.lossesByUnit[unit] || 0) + 1;
      }

// === –∫–æ–ø–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ü–†–û–¢–ò–í –∑–∞–º–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ "–ù–∏–∫–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞") ===
const oppCastle = isPlayer ? row.castleEnemy : row.castlePlayer;
if (stats[oppCastle]) {
  const ce = stats[oppCastle];
  ce.against = ce.against || { games: 0, wins: 0, losses: 0, golds: [] };
  ce.against.games++;

  // –ø–æ–±–µ–¥–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  const iWin = (isPlayer && result === "–ü–æ–±–µ–¥–∞") || (isEnemy && result === "–ü–æ–±–µ–¥–∞");
  if (iWin) ce.against.wins++; else ce.against.losses++;

  // —Ä–∞–∑–Ω–∏—Ü—É –∑–æ–ª–æ—Ç–∞ —Ç–æ–∂–µ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –∑–Ω–∞–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  ce.against.golds.push(isEnemy ? -gold : gold);
}

    });

    const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const most = obj => {
      let max = 0, name = "‚Äî";
      for (const k in obj) if (obj[k] > max) [max,name] = [obj[k],k];
      return name;
    };

    // === 1Ô∏è‚É£ –õ—é–±–∏–º—ã–π –∑–∞–º–æ–∫ ===
    const favCastle = Object.entries(stats).reduce((a,[name,s]) => 
      (s.games > (a.games||0) ? {name, ...s} : a), {games:0});
    const favUnit = most(favCastle.units);
    fillCastleCard("favCastle", favCastle.name, favCastle.games, favCastle.wins, favCastle.golds, favUnit);

    // === 2Ô∏è‚É£ –õ—É—á—à–∏–π –∑–∞–º–æ–∫ (–≤–∏–Ω—Ä–µ–π—Ç ‚â• 3 –º–∞—Ç—á–µ–π) ===
    const bestCastle = Object.entries(stats)
      .filter(([_,s]) => s.games >= 3)
      .map(([name,s]) => ({name, ...s, winrate: s.wins/s.games}))
      .sort((a,b)=>b.winrate - a.winrate)[0] || null;
    if (bestCastle) {
      const bestUnit = most(bestCastle.winsByUnit);
      fillCastleCard("bestCastle", bestCastle.name, bestCastle.games, bestCastle.wins, bestCastle.golds, bestUnit);
    } else fillNoData("bestCastle");

    // === 3Ô∏è‚É£ –•—É–¥—à–∏–π –∑–∞–º–æ–∫ ===
    const worstCastle = Object.entries(stats)
      .filter(([_,s]) => s.games >= 3)
      .map(([name,s]) => ({name, ...s, winrate: s.wins/s.games}))
      .sort((a,b)=>a.winrate - b.winrate)[0] || null;
    if (worstCastle) {
      const worstUnit = most(worstCastle.lossesByUnit);
      fillCastleCard("worstCastle", worstCastle.name, worstCastle.games, worstCastle.wins, worstCastle.golds, worstUnit);
    } else fillNoData("worstCastle");

// === 4Ô∏è‚É£ –¢—è–∂–µ–ª–æ –∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤ ===
// –°–æ–±–∏—Ä–∞–µ–º –≤–∏–Ω—Ä–µ–π—Ç –∏–≥—Ä–æ–∫–∞ –ü–†–û–¢–ò–í –∫–∞–∂–¥–æ–≥–æ –∑–∞–º–∫–∞
const castlesAgainst = {};

matches.forEach(row => {
  const isPlayer = row.nickPlayer === username;
  const isEnemy  = row.nickEnemy  === username;
  if (!isPlayer && !isEnemy) return;

  const myResult = row.result;
  const enemyCastle = isPlayer ? row.castleEnemy : row.castlePlayer;
  const iWon = (isPlayer && myResult === "–ü–æ–±–µ–¥–∞") || (isEnemy && myResult === "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ");

  if (!castlesAgainst[enemyCastle]) {
    castlesAgainst[enemyCastle] = { games: 0, wins: 0 };
  }
  castlesAgainst[enemyCastle].games++;
  if (iWon) castlesAgainst[enemyCastle].wins++;
});

// –¢–µ–ø–µ—Ä—å –≤—ã—á–∏—Å–ª—è–µ–º —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –∑–∞–º–æ–∫ (—Å–∞–º—ã–π –Ω–∏–∑–∫–∏–π winrate –∏–≥—Ä–æ–∫–∞)
let hardestCastle = null;
let lowestWR = Infinity;

for (const [castle, data] of Object.entries(castlesAgainst)) {
  if (data.games >= 3) {
    const wr = data.wins / data.games;
    if (wr < lowestWR) {
      lowestWR = wr;
      hardestCastle = { name: castle, ...data, winrate: wr };
    }
  }
}

if (hardestCastle) {
  // –ù–∞—Ö–æ–¥–∏–º —é–Ω–∏—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—â–µ –≤—Å–µ–≥–æ –ø–æ–±–µ–∂–¥–∞–ª–∏ –∏–≥—Ä–æ–∫–∞ –ø—Ä–∏ –∏–≥—Ä–∞—Ö –ø—Ä–æ—Ç–∏–≤ —ç—Ç–æ–≥–æ –∑–∞–º–∫–∞
  const lossesUnits = {};
  matches.forEach(row => {
    const isPlayer = row.nickPlayer === username;
    const isEnemy  = row.nickEnemy === username;
    const lostTo =
      (isPlayer && row.castleEnemy === hardestCastle.name && row.result === "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ") ||
      (isEnemy && row.castlePlayer === hardestCastle.name && row.result === "–ü–æ–±–µ–¥–∞");
    if (lostTo) {
      const enemyUnit = isPlayer ? row.stackEnemy : row.stackPlayer;
      if (enemyUnit && enemyUnit !== "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö") {
        lossesUnits[enemyUnit] = (lossesUnits[enemyUnit] || 0) + 1;
      }
    }
  });

  const hardUnit = Object.entries(lossesUnits).sort((a, b) => b[1] - a[1])[0]?.[0] || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –≤–∏–Ω—Ä–µ–π—Ç (–±–µ–∑ –∏–Ω–≤–µ—Ä—Å–∏–∏)
  const realWR = hardestCastle.winrate * 100;
  fillCastleCard(
    "hardCastle",
    hardestCastle.name,
    hardestCastle.games,
    hardestCastle.wins,
    [],
    hardUnit
  );

  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç (–æ–∫—Ä—É–≥–ª—ë–Ω)
  const el = document.getElementById("hardCastle-winrate");
  if (el) el.textContent = `${realWR.toFixed(1)}%`;
} else {
  fillNoData("hardCastle");
}


  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ castleStats:", err);
    ["favCastle","bestCastle","worstCastle","hardCastle"].forEach(fillNoData);
  } finally {
    tabLoader.style.display = "none";
    content.style.display = "block";
    castleStatsLoaded = true;
  }
}

// === –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
function fillCastleCard(prefix, castle, games, wins, golds, unit) {
  const castleIcons = window.castleIcons || {};
  const monsterIcons = window.monsterIcons || {};

  const elem = id => document.getElementById(`${prefix}-${id}`);

  const winrateValue = games ? ((wins / games) * 100).toFixed(1) : null;
  const winrate = games ? winrateValue + "%" : "0%";
  const avgGoldValue = golds.length ? Math.round(golds.reduce((a,b)=>a+b,0)/golds.length) : null;
  const avgGold = avgGoldValue !== null ? avgGoldValue : "‚Äî";

  // üé® –í–∏–Ω—Ä–µ–π—Ç ‚Äî —Ü–≤–µ—Ç
  let winColor = "#999";
  if (winrateValue !== null) {
    const v = parseFloat(winrateValue);
    if (v <= 30) winColor = "#ff4d4d";
    else if (v <= 49) winColor = "#ffdd55";
    else if (v <= 60) winColor = "#b4ff88";
    else if (v <= 75) winColor = "#00cc66";
    else winColor = "#3dff00";
  }

  // üé® –°—Ä–µ–¥–Ω–∏–π —Å—Ç–∞—Ä—Ç ‚Äî —Ü–≤–µ—Ç
  let startColor = "#ccc";
  if (avgGoldValue !== null) {
    const s = avgGoldValue;
    if (s <= -7500) startColor = "#ff0000";
    else if (s <= -5000) startColor = "#ff6666";
    else if (s <= -2500) startColor = "#ff9933";
    else if (s <= 0) startColor = "#ffdd55";
    else if (s <= 2500) startColor = "#b4ff88";
    else if (s <= 5000) startColor = "#00cc66";
    else if (s <= 10000) startColor = "#ffd700";
  }

  // === –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ===
  elem("name").textContent = castle || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  elem("matches").textContent = games || "‚Äî";
  elem("winrate").textContent = winrate;
  elem("gold").textContent = avgGold;
// –ø—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞
const winEl  = elem("winrate");
const goldEl = elem("gold");
if (winEl)  winEl.style.color  = winColor;
if (goldEl) goldEl.style.color = startColor;

  // === –ò–∫–æ–Ω–∫–∞ –∑–∞–º–∫–∞ ===
  const iconUrl = castleIcons[castle] || "";
  const castleIconElem = elem("icon");
  if (castleIconElem) {
    if (iconUrl) {
      castleIconElem.src = iconUrl;
      castleIconElem.alt = castle || "";
      castleIconElem.style.display = "block";
    } else {
      castleIconElem.style.display = "none";
    }
  }

  // === –Æ–Ω–∏—Ç ===
  const unitTextElem = elem("unit");
  const unitIconElem = elem("unit-icon");

  if (!unit || unit === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö") {
    // –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É, –≤—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
    if (unitIconElem) unitIconElem.style.display = "none";
    if (unitTextElem) unitTextElem.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  } else {
    const icon = monsterIcons[unit?.toLowerCase()]?.icon;
    if (icon) {
      if (unitIconElem) {
        unitIconElem.src = icon;
        unitIconElem.alt = unit;
        unitIconElem.style.display = "block";
      }
      if (unitTextElem) unitTextElem.textContent = unit;
    } else {
      // –∏–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
      if (unitIconElem) unitIconElem.style.display = "none";
      if (unitTextElem) unitTextElem.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
    }
  }
}


function fillNoData(prefix) {
  const fields = ["name","matches","winrate","gold","unit"];
  fields.forEach(f => {
    const el = document.getElementById(`${prefix}-${f}`);
    if (el) el.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  });
  const icon = document.getElementById(`${prefix}-icon`);
  if (icon) icon.src = "";
  const unitIcon = document.getElementById(`${prefix}-unit-icon`);
  if (unitIcon) unitIcon.src = "";
  const w = document.getElementById(`${prefix}-winrate`);
const g = document.getElementById(`${prefix}-gold`);
if (w) w.style.color = "";
if (g) g.style.color = "";

}
// === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≥–µ—Ä–æ—è–º ===
let heroStatsLoaded = false;

async function loadHeroStats(username) {
  const tabLoader = document.getElementById("tab-loader");
  const content = document.getElementById("hero-content");

  tabLoader.style.display = "flex";
  content.style.display = "none";

  const scriptUrl = "https://script.google.com/macros/s/AKfycbwus43_mJRl-50ygI8lbGiJDtmwDPS0HtkaxDCfIMqnSs9TzvYB4Ic1nhejEaDncYASRw/exec";

  try {
    const jsonpData = await jsonpRequest(`${scriptUrl}?action=getGeneralStats&player=${encodeURIComponent(username)}`, 10000);
    const matches = jsonpData?.values || [];
    if (!matches.length) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

// –î–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–∞—Ä—Ç—ã: –º–æ–∏ –≥–µ—Ä–æ–∏ –∏ –≥–µ—Ä–æ–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –ø—Ä–æ—Ç–∏–≤ –º–µ–Ω—è
const my = {};
const vs = {};

matches.forEach(row => {
  const isPlayer = row.nickPlayer === username;
  const isEnemy  = row.nickEnemy  === username;
  if (!isPlayer && !isEnemy) return;

  const result   = row.result;
  const iWin     = (isPlayer && result === "–ü–æ–±–µ–¥–∞") || (isEnemy && result === "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ");

  // –º–æ–∏: –≥–µ—Ä–æ–π/—é–Ω–∏—Ç —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª "–∏–≥—Ä–æ–∫–æ–º" ‚Äî –±–µ—Ä—ë–º starterPlayer / stackPlayer
  // –ï—Å–ª–∏ –æ–Ω –±—ã–ª "–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–º" ‚Äî –±–µ—Ä—ë–º starterEnemy / stackEnemy
  const myHero = isPlayer ? row.starterPlayer : row.starterEnemy;
  const myUnit = isPlayer ? row.stackPlayer   : row.stackEnemy;

  if (!my[myHero]) my[myHero] = { games:0, wins:0, units:{} };
  my[myHero].games++;
// –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–±–µ–¥—É –≥–µ—Ä–æ—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if (iWin) my[myHero].wins++;
  if (myUnit && myUnit !== "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö") {
    my[myHero].units[myUnit] = (my[myHero].units[myUnit] || 0) + 1;
  }


  // —Å–æ–ø–µ—Ä–Ω–∏–∫: –≥–µ—Ä–æ–π/—é–Ω–∏—Ç —Å –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–æ—Ç–∏–≤ –º–µ–Ω—è
  const oppHero  = isPlayer ? row.starterEnemy : row.starterPlayer;
  const oppUnit  = isPlayer ? row.stackEnemy   : row.stackPlayer;
  const oppWin   = !iWin;

  if (!vs[oppHero]) vs[oppHero] = { games:0, wins:0, unitStats:{} };
  vs[oppHero].games++;
  if (oppWin) vs[oppHero].wins++;

  if (oppUnit && oppUnit !== "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö") {
    const us = vs[oppHero].unitStats[oppUnit] || { games:0, wins:0 };
    us.games++;
    if (oppWin) us.wins++;
    vs[oppHero].unitStats[oppUnit] = us;
  }
});

const most = o => Object.entries(o).sort((a,b)=>b[1]-a[1])[0]?.[0] || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";

// ---------- 1Ô∏è‚É£ –õ—é–±–∏–º—ã–π –≥–µ—Ä–æ–π ----------
const myEntries = Object.entries(my);
const favEntry = myEntries.sort((a,b)=>b[1].games - a[1].games)[0];
fillHeroCard("favHero", favEntry ? { name:favEntry[0], ...favEntry[1] } : null);

// ---------- 2Ô∏è‚É£ –õ—É—á—à–∏–π –≥–µ—Ä–æ–π ----------
const best = myEntries
  .filter(([,s]) => s.games >= 3)
  .map(([name,s]) => ({ name, ...s, winrate: s.wins/s.games }))
  .sort((a,b) => (b.winrate - a.winrate) || (b.games - a.games))[0];
fillHeroCard("bestHero", best || null);

// ---------- 3Ô∏è‚É£ –•—É–¥—à–∏–π –≥–µ—Ä–æ–π ----------
const worst = myEntries
  .filter(([,s]) => s.games >= 3)
  .map(([name,s]) => ({ name, ...s, winrate: s.wins/s.games }))
  .sort((a,b) => (a.winrate - b.winrate) || (b.games - a.games))[0];
fillHeroCard("worstHero", worst || null);

// === 4Ô∏è‚É£ –ù–µ–Ω–∞–≤–∏—Å—Ç–Ω—ã–π –≤—Ä–∞–≥ ===
// –≤—ã—á–∏—Å–ª—è–µ–º –≤–∏–Ω—Ä–µ–π—Ç –∏–≥—Ä–æ–∫–∞ –ø—Ä–æ—Ç–∏–≤ —ç—Ç–∏—Ö –≥–µ—Ä–æ–µ–≤ (–∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º)
const vsEntries = Object.entries(vs)
  .filter(([, s]) => s.games >= 3)
  .map(([name, s]) => {
    const enemyWinrate = s.wins / s.games; // –¥–æ–ª—è –ø–æ–±–µ–¥ –≤—Ä–∞–≥–∞ –ø—Ä–æ—Ç–∏–≤ –∏–≥—Ä–æ–∫–∞
    const playerWinrate = 1 - enemyWinrate; // –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ‚Äî –ø–æ–±–µ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Ç–∏–≤ –≤—Ä–∞–≥–∞
    return {
      name,
      games: s.games,
      winrate: +(playerWinrate * 100).toFixed(1), // –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ –ø—Ä–æ—Ç–∏–≤
      unitStats: s.unitStats || {}
    };
  })
  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é winrate ‚Äî —Å–∞–º—ã–π –Ω–∏–∑–∫–∏–π = –Ω–µ–Ω–∞–≤–∏—Å—Ç–Ω—ã–π
  .sort((a, b) => (a.winrate - b.winrate) || (b.games - a.games));

const hated = vsEntries[0];

if (hated) {
  // —Å—Ä–µ–¥–∏ –µ–≥–æ —é–Ω–∏—Ç–æ–≤ –±–µ—Ä—ë–º —Ç–æ—Ç, —á–µ–π –≤–∏–Ω—Ä–µ–π—Ç –ø—Ä–æ—Ç–∏–≤ –∏–≥—Ä–æ–∫–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω
  let bestUnitName = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  let bestWr = -1, bestGames = 0;
  for (const [u, st] of Object.entries(hated.unitStats || {})) {
    const wr = st.games ? st.wins / st.games : 0;
    if (wr > bestWr || (wr === bestWr && st.games > bestGames)) {
      bestWr = wr; bestGames = st.games; bestUnitName = u;
    }
  }

  // üí° –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ –ø—Ä–æ—Ç–∏–≤
  if (!Number.isFinite(hated.winrate) || isNaN(hated.winrate)) hated.winrate = 0;
  hated.winrate = Math.max(0, Math.min(100, hated.winrate)); // –∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω

  fillHeroCard("enemyHero", {
    name: hated.name,
    games: hated.games,
    winrate: hated.winrate, // ‚Üê –ø–µ—Ä–µ–¥–∞—ë–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ –ø—Ä–æ—Ç–∏–≤
    unitOverride: bestUnitName
  });
} else {
  fillHeroCard("enemyHero", null);
}



  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ heroStats:", err);
    ["favHero","bestHero","worstHero","enemyHero"].forEach(fillHeroNoData);
  } finally {
    tabLoader.style.display = "none";
    content.style.display = "block";
    heroStatsLoaded = true;
  }
}

function fillHeroCard(prefix, data) {
  const heroIcons = window.heroIcons || {};
  const monsterIcons = window.monsterIcons || {};
  const elem = id => document.getElementById(`${prefix}-${id}`);
  if (!data) return fillHeroNoData(prefix);

  const hero = data.name || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  const winrateValue = data.games ? ((data.wins / data.games) * 100).toFixed(1) : null;
  const favUnit =
  data.unitOverride ??
  (data.units ? Object.entries(data.units).sort((a,b)=>b[1]-a[1])[0]?.[0] : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");


  // üé® –¶–≤–µ—Ç –≤–∏–Ω—Ä–µ–π—Ç–∞
  let winColor = "#999";
  if (winrateValue !== null) {
    const v = parseFloat(winrateValue);
    if (v <= 30) winColor = "#ff4d4d";
    else if (v <= 49) winColor = "#ffdd55";
    else if (v <= 60) winColor = "#b4ff88";
    else if (v <= 75) winColor = "#00cc66";
    else winColor = "#3dff00";
  }

  elem("name").textContent = hero;
  elem("matches").textContent = data.games || "‚Äî";
  // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è "–Ω–µ–Ω–∞–≤–∏—Å—Ç–Ω–æ–≥–æ –≤—Ä–∞–≥–∞") ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
const displayWr = data.winrate ?? (winrateValue ? parseFloat(winrateValue).toFixed(1) : 0);
let fixedWr = displayWr;
if (fixedWr <= 1) fixedWr = fixedWr * 100; // –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–ª—è, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ %
fixedWr = Math.round(fixedWr); // –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª–æ–≥–æ
elem("winrate").textContent = fixedWr + "%";
  elem("winrate").style.color = winColor;

  const icon = heroIcons[hero] || "";
  const unitIcon = monsterIcons[favUnit?.toLowerCase()]?.icon || "";
  elem("icon").src = icon;
  elem("unit").textContent = favUnit || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  elem("unit-icon").src = unitIcon;
}

function fillHeroNoData(prefix) {
  ["name","matches","winrate","unit"].forEach(id=>{
    const el=document.getElementById(`${prefix}-${id}`);
    if(el) el.textContent="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  });
  ["icon","unit-icon"].forEach(id=>{
    const el=document.getElementById(`${prefix}-${id}`);
    if(el) el.src="";
  });
}

    initMyStats();
    /* =====================================
     –ó–ê–ì–†–£–ó–ö–ê –ò –ü–û–°–¢–†–û–ï–ù–ò–ï –ì–†–ê–§–ò–ö–ê –≠–õ–û
  ===================================== */
  const GAS_BASE_URL = "https://script.google.com/macros/s/AKfycbyFBd0h8ErXgmA16lByhsvOgVAJ-7zFkspg1t8TuK1hS0AVr4ACizgINDNR7thG4gcgag/exec";
  let eloChartInstance = null;

  async function loadEloChart(username) {
    const base = `${GAS_BASE_URL}?action=eloHistory&username=${encodeURIComponent(username)}`;

    try {
      const res = await fetch(base, { method: "GET", mode: "cors", cache: "no-cache" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rows = await res.json();
      handleEloData(rows);
    } catch (err) {
      console.warn("fetch() –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º JSONP:", err);
      try {
        const rows = await jsonpRequest(base, 8000);
        handleEloData(rows);
      } catch (e2) {
        console.error("JSONP —Ç–æ–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:", e2);
        showNoData(true, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ");
      }
    }
  }

  function jsonpRequest(baseUrl, timeoutMs = 8000) {
    return new Promise((resolve, reject) => {
      const cbName = "jsonp_cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const src = `${baseUrl}&callback=${cbName}`;
      let done = false;

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      function cleanup() {
        if (done) return;
        done = true;
        clearTimeout(timer);
        delete window[cbName];
        script.remove();
      }

      window[cbName] = (payload) => {
        window[cbName].username = username; // üí° —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ –≤ –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        cleanup();
        resolve(payload);
      };

      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP script load error"));
      };

      script.src = src;
      document.head.appendChild(script);
    });
  }

function handleEloData(rows) {
  if (!Array.isArray(rows)) {
    showNoData(true);
    return;
  }

  const points = rows
    .slice()
    .sort((a, b) => Number(a.date) - Number(b.date))
    .map(r => ({ date: Number(r.date), label: formatDateDM(r.date), value: Number(r.elo) }))
    .filter(p => Number.isFinite(p.value));

  // === üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π ===
  const now = Date.now();
  const cutoff = now - 30 * 24 * 60 * 60 * 1000; // 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
  const recentGames = points.filter(p => p.date >= cutoff);

  if (recentGames.length < 3) {
    showNoData(true, "–°—ã–≥—Ä–∞–π—Ç–µ –±–æ–ª—å—à–µ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫.");
    return;
  }

  if (points.length < 2) {
    showNoData(true);
    return;
  }

  showNoData(false);
  renderEloChart(points);
}

// <-- –≤–æ—Ç –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å handleEloData


// === –¢–µ–ø–µ—Ä—å —É–∂–µ –æ—Ç–¥–µ–ª—å–Ω–æ ===
function renderEloChart(points) {
  const labels = points.map(p => p.label);
  const values = points.map(p => p.value);
  const ctx = document.getElementById("eloChart").getContext("2d");

  if (eloChartInstance) eloChartInstance.destroy();

  // === –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–Ω–≥–∏ ===
  const rankThresholds = ranks.map(r => ({ ...r }));
  const getRankByElo = (elo) => rankThresholds.find(r => elo >= r.min && elo <= r.max) || null;

  // === –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ä–∞–Ω–≥–∞–º–∏ ===
  const rankChanges = [];
  for (let i = 1; i < values.length; i++) {
    const prevRank = getRankByElo(values[i - 1]);
    const currRank = getRankByElo(values[i]);
    if (prevRank && currRank && prevRank.name !== currRank.name) {
      rankChanges.push({
        index: i,
        rank: currRank,
        up: currRank.min > prevRank.min
      });
    }
  }

  // === –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π, –Ω–∏–∂–Ω–∏–π –∏ –≤–µ—Ä—Ö–Ω–∏–π —Ä–∞–Ω–≥ ===
  const currentElo = values[values.length - 1];
  const currentRank = getRankByElo(currentElo);
  const lowerRank = ranks.slice().reverse().find(r => r.max < currentElo) || ranks[0];
  const upperRank = ranks.find(r => r.min > currentElo) || ranks[ranks.length - 1];
  const lowerValue = lowerRank.max;
  const upperValue = upperRank.min;

  // === –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ ===
  eloChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "–≠–ª–æ",
          data: values,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2,
          pointHoverRadius: 4,
          fill: false,
          borderColor: "#ffd700"
        },
        // –Ω–∏–∂–Ω—è—è –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è
        {
          label: `${lowerRank.name} (${lowerValue})`,
          data: Array(values.length).fill(lowerValue),
          borderColor: "rgba(255, 0, 0, 0.4)",
          borderDash: [6, 6],
          borderWidth: 1,
          pointRadius: 0,
          fill: false,
        },
        // –≤–µ—Ä—Ö–Ω—è—è –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è
        {
          label: `${upperRank.name} (${upperValue})`,
          data: Array(values.length).fill(upperValue),
          borderColor: "rgba(0, 255, 0, 0.4)",
          borderDash: [6, 6],
          borderWidth: 1,
          pointRadius: 0,
          fill: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "bottom",
          labels: { color: "#ffdd55", font: { size: 10 } }
        },
        tooltip: {
          callbacks: {
            title: (items) => items[0].label,
            label: (ctx) => `–≠–ª–æ: ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: "#e0d0a0" } },
        y: { grid: { display: true, color: "rgba(255,255,255,0.1)" }, ticks: { color: "#e0d0a0" } }
      }
    },
    plugins: [{
      id: "rankIcons",
      afterDraw(chart) {
        const { ctx, scales } = chart;
        const xScale = scales.x;
        const yScale = scales.y;
        const time = Date.now() / 500; // –¥–ª—è –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏—è

        rankChanges.forEach(change => {
          const x = xScale.getPixelForValue(change.index);
          const baseY = yScale.getPixelForValue(values[change.index]);
          const y = baseY + Math.sin(time + x / 60) * 3; // —ç—Ñ—Ñ–µ–∫—Ç –¥–≤–∏–∂–µ–Ω–∏—è

          const iconObj = window.monsterIcons?.[change.rank.icon];
          const size = 28; // —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏

          if (iconObj?.icon) {
            const img = new Image();
            img.src = iconObj.icon;
            ctx.save();
            ctx.drawImage(img, x - size / 2, y - size - 8, size, size);
            ctx.restore();
          } else {
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y - 10, 8, 0, 2 * Math.PI);
            ctx.fillStyle = change.up ? "limegreen" : "red";
            ctx.fill();
            ctx.restore();
          }
        });

        // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        requestAnimationFrame(() => chart.draw());
      }
    }]
  });
}
function showNoData(show, msg) {
    const canvas = document.getElementById("eloChart");
    const parent = canvas.parentElement;
    let note = document.getElementById("eloChartEmpty");
    if (!note) {
      note = document.createElement("div");
      note.id = "eloChartEmpty";
      note.style = "text-align:center;padding:36px 8px;opacity:.8;font-style:italic;";
      parent.appendChild(note);
    }
    note.textContent = msg || "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞";
    note.style.display = show ? "block" : "none";
    canvas.style.display = show ? "none" : "block";
  }

  function formatDateDM(ts) {
    const d = new Date(Number(ts));
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    return `${dd}.${mm}`;
  }
// === –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∑–∞–º–∫–æ–≤ ===
const fullCastleBtn = document.getElementById("open-full-castle-stats");
if (fullCastleBtn) {
  fullCastleBtn.addEventListener("click", () => {
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–º–æ—Ç—Ä–∏–º
    localStorage.setItem("selectedUsername", username);
    window.location.href = "castle_stat_player.html";
  });
}
</script>

  <style>
    body {
      background: url('https://i.postimg.cc/qv2pzHrV/image.gif') no-repeat center center fixed;
      background-size: cover;
      background-color: #0a0a1a;
      color: #e0d0a0;
      font-family: 'Press Start 2P', cursive;
    }

    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background-color: rgba(0, 15, 50, 0.1);
      border: 3px solid #6e4f1a;
      border-radius: 8px;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.7), 0 0 15px rgba(200, 150, 50, 0.4);
    }

    .page-title {
      font-size: 1.2rem; color: #ffdd55; text-align: center; margin-bottom: 30px;
    }

    .stats-wrapper { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; justify-content: space-between; }

    /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
    .player-info {
      flex: 0 0 260px;
      text-align: center;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #6e4f1a;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .player-name { font-size: 0.9rem; color: #ffdd55; margin-bottom: 10px; text-shadow: 0 0 10px rgba(255,255,0,.5); }

    .hero-frame {
      border: 3px solid #6e4f1a; border-radius: 8px; overflow: hidden;
      width: 140px; height: 140px; margin: 0 auto; box-shadow: 0 0 10px rgba(255,220,100,.2);
      display: grid; place-items: center;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.4), rgba(0,0,0,.7));
    }
    .hero-frame img { width: 100%; height: 100%; object-fit: cover; }

    .player-elo, .player-rank { font-size: 0.8rem; margin-top: 8px; color: #ffd700; text-shadow: 0 0 5px rgba(255,255,255,.3); }

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
    .stats-section { flex: 1 1 70%; }

    .section-title { font-size: 0.9rem; margin-bottom: 15px; color: #ffdd55; text-align: center; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
    .stat-card { background: rgba(0,0,0,.6); border: 2px solid #6e4f1a; border-radius: 8px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,.5); transition: transform .2s ease; }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 0 10px rgba(255,220,100,.4); }
    .stat-label { font-size: 0.7rem; opacity: .8; margin-bottom: 8px; }
    .stat-value { font-size: 1.2rem; color: #ffd700; }

    /* –õ–æ–∞–¥–µ—Ä */
.loader-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
  backdrop-filter: blur(2px);
}

.loader {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #ffdd55;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

    .chart-wrapper {
  position: relative;
  width: 100%;
  height: 260px;
  margin: 0 auto;
  background: rgba(0, 0, 0, 0.3);
  border: 2px solid #6e4f1a;
  border-radius: 8px;
  padding: 8px;
  box-sizing: border-box;
}
.chart-wrapper canvas {
  width: 100% !important;
  height: 100% !important;
}
.tabs {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  width: 100%;
  margin-bottom: 18px;
  border: 2px solid #6e4f1a;
  border-radius: 6px;
  overflow: hidden;
  background: rgba(10, 10, 25, 0.85);
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.6), 0 0 15px rgba(255, 200, 60, 0.3);
}

.tab-button {
  border: none;
  border-right: 1px solid rgba(255, 215, 100, 0.25); /* –∑–æ–ª–æ—Ç–æ–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
  color: #ffdd55;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.8rem;
  padding: 12px 6px;
  background: linear-gradient(to bottom, rgba(25, 25, 50, 0.9), rgba(15, 15, 30, 0.9));
  cursor: pointer;
  transition: all 0.25s ease;
  text-shadow: 0 0 6px rgba(255, 255, 200, 0.4);
}

.tab-button:last-child {
  border-right: none;
}

.tab-button:hover {
  background: linear-gradient(to bottom, rgba(70, 50, 20, 0.9), rgba(40, 30, 10, 0.9));
  color: #fff8b0;
  box-shadow: inset 0 0 8px rgba(255, 230, 120, 0.5);
}

.tab-button.active {
  background: linear-gradient(to bottom, rgba(120, 90, 30, 0.95), rgba(90, 60, 20, 0.9));
  color: #fff;
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.6), 0 0 12px rgba(255, 220, 100, 0.7);
  transform: scale(1.02);
  z-index: 1;
}


.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
.castle-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 20px;
}

.castle-info, .castle-units {
  flex: 1 1 45%;
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid #6e4f1a;
  border-radius: 8px;
  padding: 15px;
  box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
}

.castle-label {
  font-size: 0.65rem;
  color: #ffdd55;
  margin-bottom: 6px;
}

.castle-value {
  font-size: 0.9rem;
  color: #fff;
  margin-bottom: 10px;
}

.castle-units ul {
  list-style: none;
  padding: 0;
  margin: 6px 0 0;
}

.castle-units li {
  font-size: 0.8rem;
  margin: 3px 0;
  color: #ffd;
}
#tab-loader {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000; /* –ø–æ–≤–µ—Ä—Ö –≤–∫–ª–∞–¥–æ–∫ */
  backdrop-filter: blur(3px);
}

#tab-loader .loader {
  border: 6px solid #ccc;
  border-top: 6px solid #ffdd55;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}
/* === –ë–ª–∏–∂–∞–π—à–∏–µ —Ä–∞–Ω–≥–∏ === */
.rank-table {
  margin-top: 18px;
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid #6e4f1a;
  border-radius: 8px;
  padding: 10px;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
}

.rank-table-title {
  text-align: center;
  color: #ffdd55;
  font-size: 0.7rem;
  margin-bottom: 10px;
  text-shadow: 0 0 6px rgba(255, 220, 100, 0.4);
}

.rank-table-body {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.rank-row {
  display: grid;
  grid-template-columns: 28px 1fr auto;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.05);
  padding: 4px 6px;
  border-radius: 4px;
}

.rank-row.current {
  background: rgba(255, 215, 0, 0.15);
  border: 1px solid rgba(255, 215, 0, 0.4);
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
}

.rank-row-icon img {
  width: 26px;
  height: 26px;
  object-fit: contain;
  filter: drop-shadow(0 0 4px rgba(255, 220, 100, 0.4));
}

.rank-row-name {
  font-size: 0.7rem;
  color: #ffd;
}

.rank-row-range {
  font-size: 0.65rem;
  color: #ccc;
  text-align: right;
}
.castle-grid-4 {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
}

.castle-card {
  position: relative;
  background: rgba(0, 20, 60, 0.75);
  border: 2px solid #6e4f1a;
  border-radius: 8px;
  padding: 15px;
  text-align: center;
  box-shadow:
    inset 0 0 15px rgba(0, 0, 40, 0.6),
    0 0 10px rgba(255, 220, 100, 0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  animation: pulseGlow 4s ease-in-out infinite;
}

.castle-card:hover {
  transform: translateY(-3px);
  box-shadow:
    0 0 15px rgba(255, 230, 120, 0.6),
    inset 0 0 12px rgba(0, 0, 40, 0.8);
}

/* ‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –º—è–≥–∫–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è —Ä–∞–º–∫–∏ */
@keyframes pulseGlow {
  0%, 100% {
    box-shadow:
      0 0 10px rgba(255, 220, 100, 0.2),
      inset 0 0 15px rgba(0, 0, 40, 0.6);
  }
  50% {
    box-shadow:
      0 0 20px rgba(255, 220, 100, 0.45),
      inset 0 0 20px rgba(0, 0, 60, 0.8);
  }
}


.castle-card-title {
  font-size: 0.75rem;
  color: #ffdd55;
  margin-bottom: 10px;
  text-shadow: 0 0 6px rgba(255,220,100,0.4);
}

.castle-card-body {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.castle-icon-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 8px 0;
}

.castle-icon-block img {
  width: 64px;
  height: 64px;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(255,220,100,0.3);
  background: rgba(20, 20, 40, 0.4);
}

.castle-name {
  margin-top: 4px;
  color: #fff;
  font-size: 0.8rem;
}

.castle-stat {
  font-size: 0.7rem;
  color: #ddd;
  margin: 2px 0;
}
.castle-full-link {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  margin: 0 0 10px;
}

.castle-full-link.top-link {
  margin-bottom: 25px;
}

.castle-full-link button {
  background: linear-gradient(to bottom, rgba(70,50,20,0.9), rgba(40,30,10,0.9));
  color: #ffdd55;
  border: 2px solid #6e4f1a;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.7rem;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  text-shadow: 0 0 6px rgba(255,220,100,0.4);
  transition: all 0.2s ease;
  box-shadow: 0 0 10px rgba(255,220,100,0.3);
}

.castle-full-link button:hover {
  background: linear-gradient(to bottom, rgba(110,79,26,0.9), rgba(70,50,20,0.9));
  color: #fff8b0;
  box-shadow: 0 0 15px rgba(255,220,100,0.5);
  transform: scale(1.05);
}



  </style>
</body>
</html>
