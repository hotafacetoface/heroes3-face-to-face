<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–õ–∏—Ü–æ–º –∫ –ª–∏—Ü—É ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–º–∫–∞–º</title>
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="css/style.css">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>

<body>
  <!-- –ú–µ–Ω—é -->
  <div id="menu-placeholder"></div>

  <!-- ‚úÖ –õ–æ–∞–¥–µ—Ä -->
  <div id="loader" class="loader-overlay" style="display:none;">
    <div class="loader"></div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
  <div class="content-box" style="width: 95%; margin: 40px auto;">
    <div class="section-title" id="castle-title">
      –ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ó–ê–ú–ö–ê–ú
    </div>

    <div class="table-responsive">
      <table id="castle-stats-table" class="table">
        <colgroup>
          <col style="width:90px;">
          <col style="width:90px;">
          <col style="width:80px;">
          <col style="width:80px;">
          <col style="width:80px;">
          <col style="width:100px;">
          <col style="width:100px;">
          <col style="width:80px;">
          <col style="width:100px;">
          <col style="width:80px;">
          <col style="width:80px;">
          <col style="width:100px;">
        </colgroup>

        <thead>
          <tr>
            <th><div class="column-header"><div class="column-title">–ó–∞–º–æ–∫</div></div></th>
            <th><div class="column-header"><div class="column-title">–°—ã–≥—Ä–∞–Ω–æ</div></div></th>
            <th><div class="column-header"><div class="column-title">–í–∏–Ω—Ä–µ–π—Ç</div></div></th>
            <th><div class="column-header"><div class="column-title">–ü–æ–±–µ–¥</div></div></th>
            <th><div class="column-header"><div class="column-title">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div></div></th>
            <th><div class="column-header"><div class="column-title">–ì–µ—Ä–æ–π</div></div></th>
            <th><div class="column-header"><div class="column-title">–Æ–Ω–∏—Ç</div></div></th>
            <th><div class="column-header"><div class="column-title">–ë–æ–Ω—É—Å</div></div></th>
            <th><div class="column-header"><div class="column-title">–¢–æ—Ä–≥</div></div></th>
            <th><div class="column-header"><div class="column-title">–ì–ú</div></div></th>
            <th><div class="column-header"><div class="column-title">–≠–∫–æ–Ω–æ–º.</div></div></th>
            <th><div class="column-header"><div class="column-title">–§–∏–Ω–∞–ª</div></div></th>
          </tr>
        </thead>
        <tbody id="castle-stats-body"></tbody>
      </table>
    </div>
  </div>

  <!-- –ò–∫–æ–Ω–∫–∏ –∏ –æ–±—â–∏–π JS -->
  <script src="js/icons-castles.js"></script>
  <script src="js/icons-heroes.js"></script>
  <script src="js/icons-monsters.js"></script>
  <script src="js/main.js"></script>

  <script>
    // === –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–µ–Ω—é ===
    fetch("menu.html")
      .then(r => r.text())
      .then(d => {
        document.getElementById("menu-placeholder").innerHTML = d;
        if (typeof initMenu === "function") initMenu();
        initCastleStatsTable();
      })
      .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", err));

    // === –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    function initCastleStatsTable() {
      const username = localStorage.getItem('selectedUsername') || 'Test3';
      document.getElementById("castle-title").innerHTML = `
        –ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ó–ê–ú–ö–ê–ú –ò–ì–†–û–ö–ê 
        <span class="player-name">${username}</span>
      `;
      loadPlayerStats(username);
    }

    // === JSONP-–∑–∞–ø—Ä–æ—Å ===
    function loadPlayerStats(username) {
      const loader = document.getElementById("loader");
      loader.style.display = "flex";

      const scriptUrl = "https://script.google.com/macros/s/AKfycbwus43_mJRl-50ygI8lbGiJDtmwDPS0HtkaxDCfIMqnSs9TzvYB4Ic1nhejEaDncYASRw/exec";
      const url = `${scriptUrl}?action=getGeneralStats&player=${encodeURIComponent(username)}&callback=processStats`;
      const script = document.createElement("script");
      script.src = url;
      document.body.appendChild(script);
    }

    // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
    function processStats(data) {
      const loader = document.getElementById("loader");
      const icons = window.castleIcons || {};
      const heroIcons = window.heroIcons || {};
      const monsterIcons = window.monsterIcons || {};
      const username = localStorage.getItem('selectedUsername') || 'Test3';

      const orderedCastles = [
        "–ó–∞–º–æ–∫","–û–ø–ª–æ—Ç","–ë–∞—à–Ω—è","–ò–Ω—Ñ–µ—Ä–Ω–æ","–ù–µ–∫—Ä–æ–ø–æ–ª–∏—Å",
        "–¢–µ–º–Ω–∏—Ü–∞","–¶–∏—Ç–∞–¥–µ–ª—å","–ö—Ä–µ–ø–æ—Å—Ç—å","–°–æ–ø—Ä—è–∂–µ–Ω–∏–µ","–ü—Ä–∏—á–∞–ª","–§–∞–±—Ä–∏–∫–∞"
      ];

      const stats = {};
      orderedCastles.forEach(c => stats[c] = {
        games: 0, wins: 0, losses: 0,
        heroes: {}, units: {}, bonuses: {},
        eco: {}, gm: {}, starts: [], finals: []
      });

      const safe = v => (v === "" || v === undefined || v === null ? "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" : v);

      (data.values || []).forEach(row => {
        const nickPlayer = safe(row.nickPlayer);
        const nickEnemy = safe(row.nickEnemy);
const isPlayer = nickPlayer.toLowerCase() === username.toLowerCase();
const isEnemy  = nickEnemy.toLowerCase() === username.toLowerCase();

        if (!isPlayer && !isEnemy) return;

        const castle = isPlayer ? safe(row.castlePlayer) : safe(row.castleEnemy);
        if (!stats[castle]) return;

        const cs = stats[castle];
        cs.games++;

        const res = safe(row.result);
        const win = (isPlayer && res === "–ü–æ–±–µ–¥–∞") || (isEnemy && res === "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ");
        win ? cs.wins++ : cs.losses++;

        const hero = isPlayer ? safe(row.starterPlayer) : safe(row.starterEnemy);
        const unit = isPlayer ? safe(row.stackPlayer) : safe(row.stackEnemy);
        const bonus = isPlayer ? safe(row.bonusPlayer) : safe(row.bonusEnemy);
        const eco = safe(row.eco);
        const gm = isPlayer ? safe(row.gm) : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        const gold = safe(row.goldDiff);
        const final = safe(row.final);

        if (hero) cs.heroes[hero] = (cs.heroes[hero] || 0) + 1;
        if (unit) cs.units[unit] = (cs.units[unit] || 0) + 1;
        if (bonus) cs.bonuses[bonus] = (cs.bonuses[bonus] || 0) + 1;
        if (eco) cs.eco[eco] = (cs.eco[eco] || 0) + 1;
        if (gm) cs.gm[gm] = (cs.gm[gm] || 0) + 1;

        const goldNum = isNaN(gold) ? 0 : Number(gold);
        cs.starts.push(isEnemy ? -goldNum : goldNum);

        const finalNum = parseInt(final);
        if (!isNaN(finalNum)) cs.finals.push(finalNum);
      });

      const body = document.getElementById("castle-stats-body");
body.innerHTML = orderedCastles.map(castle => {
  const cs = stats[castle];
  const hasGames = cs.games > 0;

  const winrateValue = hasGames ? ((cs.wins / cs.games) * 100).toFixed(1) : null;
  const winrate = hasGames ? winrateValue + "%" : "–Ω–µ—Ç –º–∞—Ç—á–µ–π";
  const avgStartValue = hasGames ? avg(cs.starts) : null;
  const avgStart = hasGames ? avgStartValue.toFixed(0) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π";
  const avgFinal = hasGames ? convertToDateFormat(avg(cs.finals)) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π";

  const rowData = {
    played: hasGames ? cs.games : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    winrate,
    winrateValue,
    wins: hasGames ? cs.wins : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    losses: hasGames ? cs.losses : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    hero: hasGames ? most(cs.heroes) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    unit: hasGames ? most(cs.units) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    bonus: hasGames ? most(cs.bonuses) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    start: avgStart,
    startValue: avgStartValue,
    gm: hasGames ? most(cs.gm) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    eco: hasGames ? most(cs.eco) : "–Ω–µ—Ç –º–∞—Ç—á–µ–π",
    time: avgFinal
  };

  // üé® –í–∏–Ω—Ä–µ–π—Ç ‚Äî —Ü–≤–µ—Ç
  let winColor = "#999";
  if (rowData.winrateValue !== null) {
    const v = rowData.winrateValue;
    if (v <= 30) winColor = "#ff4d4d";
    else if (v <= 49) winColor = "#ffdd55";
    else if (v <= 60) winColor = "#b4ff88";
    else if (v <= 75) winColor = "#00cc66";
    else winColor = "#3dff00";
  }

  // üé® –ë–æ–Ω—É—Å ‚Äî —Ü–≤–µ—Ç
  const bonusLower = rowData.bonus.toLowerCase();
  let bonusColor = "#ccc";
  if (bonusLower.includes("–∞—Ä—Ç–µ—Ñ–∞–∫—Ç")) bonusColor = "#c77dff";
  else if (bonusLower.includes("–∑–æ–ª–æ—Ç–æ")) bonusColor = "#ffd700";
  else if (bonusLower.includes("—Ä–µ—Å—É—Ä—Å")) bonusColor = "#a0522d";
  else if (bonusLower.includes("—Å–ª—É—á")) bonusColor = "#ff4444";

  // üé® –°—Ä–µ–¥–Ω–∏–π —Å—Ç–∞—Ä—Ç ‚Äî —Ü–≤–µ—Ç
  let startColor = "#ccc";
  if (rowData.startValue !== null) {
    const s = rowData.startValue;
    if (s <= -7500) startColor = "#ff0000";
    else if (s <= -5000) startColor = "#ff6666";
    else if (s <= -2500) startColor = "#ff9933";
    else if (s <= 0) startColor = "#ffdd55";
    else if (s <= 2500) startColor = "#b4ff88";
    else if (s <= 5000) startColor = "#00cc66";
    else if (s <= 10000) startColor = "#ffd700";
  }

  // üßô –ì–µ—Ä–æ–π
  const heroIcon = heroIcons[rowData.hero] || "";
  const heroCell = heroIcon && rowData.hero !== "–Ω–µ—Ç –º–∞—Ç—á–µ–π"
    ? `<div style="display:flex;flex-direction:column;align-items:center;">
         <img src="${heroIcon}" alt="${rowData.hero}" style="width:28px;height:28px;">
         <div style="font-size:9px;color:#ffdd55;">${rowData.hero}</div>
       </div>`
    : `<div>${rowData.hero}</div>`;

  // üêâ –Æ–Ω–∏—Ç
  const unitKey = rowData.unit.toLowerCase().trim();
  const unitIcon = monsterIcons[unitKey]?.icon || "";
  const unitCell = unitIcon && rowData.unit !== "–Ω–µ—Ç –º–∞—Ç—á–µ–π"
    ? `<div style="display:flex;flex-direction:column;align-items:center;">
         <img src="${unitIcon}" alt="${rowData.unit}" style="width:28px;height:28px;">
         <div style="font-size:9px;color:#ffdd55;">${rowData.unit}</div>
       </div>`
    : `<div>${rowData.unit}</div>`;

  return `
    <tr>
      <td style="text-align:center;">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
          <img src="${icons[castle]}" alt="${castle}">
          <div style="font-size:10px;color:#ffdd55;">${castle}</div>
        </div>
      </td>
      <td>${rowData.played}</td>
      <td style="color:${winColor};font-weight:bold;">${rowData.winrate}</td>
      <td>${rowData.wins}</td>
      <td>${rowData.losses}</td>
      <td>${heroCell}</td>
      <td>${unitCell}</td>
      <td style="color:${bonusColor};">${rowData.bonus}</td>
      <td style="color:${startColor};">${rowData.start}</td>
      <td>${rowData.gm}</td>
      <td>${rowData.eco}</td>
      <td>${rowData.time}</td>
    </tr>`;
}).join("");


      $('#castle-stats-table').DataTable({
        paging:false, info:false, searching:false,
        order:[[1,"desc"]],
        language:{url:"https://cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json"}
      });

      loader.style.display = "none";
    }

    function avg(a){return a.length?a.reduce((x,y)=>x+y,0)/a.length:0;}
    function most(o){let m=0,v="";for(const k in o)if(o[k]>m)[m,v]=[o[k],k];return v||"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";}
    function convertToDateFormat(n){
  if(!n || isNaN(n)) return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  const m = Math.floor(n / 100);
  const w = Math.floor((n % 100) / 10);
  const d = Math.ceil(n % 10); // –æ–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö
  return `${m}–º ${w}–Ω ${d}–¥`;
}
  </script>


  <style>
    body { background:url('https://i.postimg.cc/qv2pzHrV/image.gif') no-repeat center center fixed; background-size:cover; background-color:#0a0a1a; }

    .loader-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      backdrop-filter: blur(2px);
    }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #ffdd55;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* === –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (—Ç–≤–æ—ë —Ç–µ–∫—É—â–µ–µ) === */
    .dataTables_wrapper .dataTables_empty {
      color: #ffdd55 !important;
      font-size: 10px;
      text-shadow: 0 0 5px rgba(255, 220, 100, 0.4);
    }
    #castle-title { text-shadow: 0 0 6px rgba(255, 220, 100, 0.7); }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 10px;
      background: rgba(0, 15, 50, 0.3);
      border: 2px solid #6e4f1a;
      box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.6);
      table-layout: fixed;
    }
    .table th, .table td {
      padding: 5px 3px;
      border-bottom: 1px solid rgba(255, 220, 100, 0.2);
      color: #e8e0c0;
      text-align: center;
      vertical-align: middle;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    /* === –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ === */
.table th {
  background: linear-gradient(180deg, rgba(0,40,120,0.95) 0%, rgba(0,20,80,0.9) 100%);
  color: #ffdd55;
  text-shadow: 0 0 5px rgba(255, 220, 100, 0.6);
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  font-weight: normal;
  text-align: center;
  vertical-align: middle;
  padding: 6px 4px;
  height: 38px;
  line-height: 1.1;
  border-bottom: 1px solid rgba(255, 220, 100, 0.2);
  border-right: 1px solid rgba(255, 220, 100, 0.1);
  box-sizing: border-box;
  letter-spacing: 0.5px;
}

.table th div.column-header {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
}

.table th div.column-title {
  display: inline-block;
  width: 100%;
  word-wrap: break-word;
  text-align: center;
  line-height: 1.2;
}

    .table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.05);
    }
    .table th:hover {
      background: rgba(70, 50, 20, 0.8);
      color: #fff6b0;
    }
    .table td img {
      width: 26px;
      height: 26px;
      vertical-align: middle;
      margin-right: 4px;
    }
  </style>
</body>
</html>
