<!DOCTYPE html>
<html lang="ru">
<head>
 <head>
  <!-- jQuery (–¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –ø–µ—Ä–≤—ã–º) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

  <!-- Moment.js + —Ä—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª—å -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ru.min.js"></script>

  <!-- DataTables (jQuery –≤–µ—Ä—Å–∏—è) -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- –ü–ª–∞–≥–∏–Ω —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–∞—Ç: –ü–û–î–ö–õ–Æ–ß–ê–ï–¢–°–Ø –ü–û–°–õ–ï DataTables -->
  <script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/datetime-moment.js"></script>

  <!-- JS —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–∫–∞–∫ –Ω–∞ index.html) -->
  <script src="js/icons-castles.js"></script>
  <script src="js/icons-heroes.js"></script>
  <script src="js/icons-monsters.js"></script>


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—Ü–æ–º –∫ –ª–∏—Ü—É ‚Äî –ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  
  
</head>
<body>
  <!-- –ú–µ–Ω—é -->
  <div id="menu-placeholder"></div>

  <!-- –õ–æ–∞–¥–µ—Ä -->
  <div class="loader-container" id="loader">
    <div class="loader-box">
      <div class="loader-header">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç—á–µ–π</div>
      <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
      <div class="loader-text" id="loader-text">0%</div>
    </div>
  </div>

  <h1>–ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π</h1>

  <div class="table-responsive">
    <table id="history-table" class="table">
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–ò–≥—Ä–æ–∫</th>
          <th>–ó–∞–º–æ–∫</th>
          <th>–ì–µ—Ä–æ–π</th>
          <th>–°—Ç–µ–∫</th>
          <th>–ë–æ–Ω—É—Å</th>
          <th>–¶–≤–µ—Ç</th>
          <th>–†–∞–∑–Ω–∏—Ü–∞</th>
          <th>–¶–≤–µ—Ç –æ–ø.</th>
          <th>–ë–æ–Ω—É—Å –æ–ø.</th>
          <th>–°—Ç–µ–∫ –æ–ø.</th>
          <th>–ì–µ—Ä–æ–π –æ–ø.</th>
          <th>–ó–∞–º–æ–∫ –æ–ø.</th>
          <th>–û–ø–ø–æ–Ω–µ–Ω—Ç</th>
          <th>–ò—Å—Ö–æ–¥</th>
        </tr>
      </thead>
      <tbody>
        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
      </tbody>
    </table>
  </div>

  <div class="debug-info" id="debug-info"></div>

  <script src="js/main.js"></script>
<script>
  const HISTORY_API_URL = "https://script.google.com/macros/s/AKfycbyN_b-j0U_p7cqkfC9glBhL_ZwIuseHo0ybUdhy148rnWV19Da6D9K_MHWSxfQHhyGmxA/exec";

  fetch("menu.html")
    .then(r => r.text())
    .then(d => {
      document.getElementById("menu-placeholder").innerHTML = d;
      if (typeof initMenu === "function") initMenu();
      if (typeof initMatchHistoryTable === "function") initMatchHistoryTable(HISTORY_API_URL);
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", err));
</script>
<script>
/* === –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥–∏ –∫ —Ü–≤–µ—Ç–∞–º, –Ω–µ —Ç—Ä–æ–≥–∞—è main.js === */
document.addEventListener("DOMContentLoaded", () => {
  // –∂–¥—ë–º –∫–æ–≥–¥–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø–æ—è–≤–∏—Ç—Å—è
  const observer = new MutationObserver(() => {
    const table = document.getElementById("history-table");
    if (!table) return;

    const rows = table.querySelectorAll("tbody tr");
    if (rows.length === 0) return;

    for (const tr of rows) {
      const cells = tr.querySelectorAll("td");
      if (cells.length < 9) continue;

      const colorCell = cells[6];       // —Å—Ç–æ–ª–±–µ—Ü "–¶–≤–µ—Ç"
      const enemyColorCell = cells[8];  // —Å—Ç–æ–ª–±–µ—Ü "–¶–≤–µ—Ç –≤—Ä–∞–≥–∞"

      const decorate = cell => {
        const txt = (cell.textContent || "").trim().toLowerCase();
        if (txt.includes("–∫—Ä–∞—Å")) cell.textContent = "üü• " + cell.textContent.trim();
        else if (txt.includes("—Å–∏–Ω")) cell.textContent = "üü¶ " + cell.textContent.trim();
      };

      decorate(colorCell);
      decorate(enemyColorCell);
    }

    observer.disconnect(); // —Å—Ä–∞–±–æ—Ç–∞–ª–æ –æ–¥–∏–Ω —Ä–∞–∑, –±–æ–ª—å—à–µ –Ω–µ —Å–ª–µ–¥–∏–º
  });

  // —Å–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ tbody (main.js –Ω–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
  const target = document.querySelector("#history-table tbody");
  if (target) observer.observe(target, { childList: true });
});
</script>
<script>
  // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —è—á–µ–π–∫–∏ "–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫" (14-–π —Å—Ç–æ–ª–±–µ—Ü) –≤ —Å—Å—ã–ª–∫–∏ –Ω–∞ stats-player.html
  (function linkifyOpponents(){
    const table = document.getElementById('history-table');
    if (!table) return;

    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ <a> –≤ —É–∂–µ –≥–æ—Ç–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
    function process() {
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(tr => {
        const cell = tr.children[13]; // 14-–π —Å—Ç–æ–ª–±–µ—Ü (–∏–Ω–¥–µ–∫—Å 13)
        if (!cell || cell.dataset.linkified === '1') return;
        const name = (cell.textContent || '').trim();
        if (!name) return;
        cell.innerHTML = `<a href="stats-player.html?user=${encodeURIComponent(name)}" class="enemy-link">${name}</a>`;
        cell.dataset.linkified = '1';
      });
    }

    // –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
    process();

    // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ç–∞–±–ª–∏—Ü—ã (–ø–µ–π–¥–∂–∏–Ω–≥/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ DataTables)
    const mo = new MutationObserver(process);
    mo.observe(table.tBodies[0], { childList: true, subtree: true });
  })();
</script>
</body>
</html>
